# 데이터 파이프라인

## 1. 머신러닝 파이프라인

머신러닝 파이프라인 구축의 이점 : 모델 생애 주기(Model Lifecycle) 단계를 자동화할 수 있다는 점



새로운 훈련 데이터를 쓰려면 데이터 검증, 전처리, 모델 훈련, 분석 및 배포를 포함하는 워크플로 재설정해야 함



### 1.2 파이프라인 구축 시기

그러면 언제 파이프라인 구축을 고려해야 할까?

모든 시기에 또는, 모든 데이터 과학 프로젝트에 파이프라인 구축이 필요한 것은 아니다.

모델 실험 단게, 아키텍처 조사, 논문 재현 등의 과정에서는 그다지 필요성을 느낄 수는 없다.

그러나 서비스로 제공하는 모델인 경우, 즉 사용자가 존재하는 경우에는 지속적인 모델 업데이트와 세부 조정을 해줘야 한다.

모델의 지속적인 업데이트 자동화로 데이터 사이언티스트의 작업 부담을 줄여줄 수 있다.

또한 프로젝트의 수가 증가할 때 머신러닝 파이프라인은 더욱 빛을 발한다.





### 1.3 머신러닝 파이프라인 단계

파이프라인은 대략 다음과 같이 구성된다.

1. 새로운 데이터 수집
2. 새로운 데이터를 통한 모델 학습
3. 모델 동작과 그에 대한 피드백 수용

중간에 데이터 전처리, 모델 학습, 모델 분석, 모델 배포 등 다양한 단계가 포함된다.

이러한 전체 과정을 일일이 사람이 수동으로 하기에는 번거롭고 에러의 위험성도 높아진다. 그렇기에 파이프라인과 워크플로를 짜놓고 자동화하는 것이 편리하고 좋다.

<img src="C:\Users\jay\Desktop\code\DE\pipeline구축\살아움직이는 머신러닝 파이프라인 설계\1-1.PNG" alt="1-1" style="zoom:100%;" align="Left"/>

파이프라인은 다음과 같이 진행된다.



데이터 수집 / 버전 관리

- 데이터를 수집하고, 데이터 검증을 할 수 있게끔 맞는 형식으로 데이터를 처리
- 이 단계에서는 feature engineering을 진행하지 않는다.
- 데이터 버전의 스냅샷을 찍어 관리를 하고 파이프라인의 끝의 모델과 연결해주는 단계



데이터 검증

- 모델 학습하기전 데이터 검증은 꼭 해야한다.
- 통계적으로 의미가 있는지 (분포, 불균형한 데이터 등을 사전 검증)
- 검증 후 이상이 감지되면 사용자에게 경고해줌



데이터 전처리

- 모델 학습에 적절한 형태로 데이터를 전처리해주는 단계



모델 학습과 튜닝

- 말 그대로 학습 후 Loss를 최소화하는 하이퍼파라미터를 변경



모델 분석

- 모델 결정 후 모델의 성능을 더 심층적으로 분석하는 단계
- precision, recall, AUC등 과같은 지표를 통해 계산하거나, 학습시 검증 집합보다 더 큰 데이터셋에서 성능을 계산하는 작업이 포함된다.



모델 버전 관리

- 새로운 모델이 학습되어 분석을 통해 결정되었을 때 어떤 모델, 하이퍼파라미터 세트, 데이터셋 등이 선택되었는지를 추적하는 단계



모델 배포

- REST, RPC Protocal API Interface 제공
- 동일한 모델의 여러 버전을 동시에 호스팅
- 호스팅 된 모델의 A/B 테스트를 실행하면서 모델 개선 사항에 대한 피드백 확보
- 모델 서버 이용시 애플리케이션 재배포없이 모델 버전 업데이트 가능



피드백 루프

- 파이프라인이 끝나면 피드백을 통해 다시 파이프라인 실행
- 피드백을 통해 새로 만들어진 모델의 효과와 성능 측정, 모델 성능에 관한 중요한 정보 측정



개인 정보 보호

- 개인 정보 보호는 머신러닝 파이프라인 외부에 존재.
- 개인 정보 보호 기법이 파이프라인 속으로 통합될 가능성이 높음
- 개인 정보 보호 강화 옵션 예시
  - 차등 개인 정보 보호(differential privacy) : 수학 연산을 활용해 모델 예측이 사용자의 데이터를 노출하지 않도록 보장
  - 연합 학습(federated learnwing) : 원시 데이터가 사용자의 장치로부터 다른 곳으로 이전되지 않도록 함
  - 암호화된 머신러닝(encrypted machine learning) : 전체 학습 프로세스를 암호화된 공간에서 실행하거나 원시 데이터에서 훈련된 모델을 암호화



### 1.4 파이프라인 오케스트레이션

앞의 파이프라인 단계들을 실행하고, 컴포넌트가 올바른 순서로 실행되도록 조정해야 한다.

(컴포넌트 실행 전 해당 컴포넌트에 필요한 모든 입력값이 준비해야 함)

단계 조정에 쓰이는 도구 예시는 다음과 같다.

- 아파치 빔(Apache Beam)
- 아파치 에어플로(Apache Airflow)
- 쿠버네티스(Kubernetes) 인프라용 쿠브플로(Kubeflow) 파이프라인



데이터 파이프라인 도구가 머신러닝 파이프라인 단계를 조정하는 동안, Tensorflow ML MetadataStore와 같은 파이프라인 아티팩트(artifact) 저장소는 개별 프로세스의 산출물을 저장함



### 1.4.1 파이프라인 오케스트레이션의 필요성

프로젝트마다 머신러닝 파이프라인 단계 사이를 연결하는 커스텀 코드가 다 다르다. 어떤 프로젝트는 어떤 코드를 쓰고, 또 다른 프로젝트는 다른 코드를 쓰고 표준화된 코드가 아니다.

빔, 에어플로, 쿠브플로 파이프라인 같은 도구를 통해 머신러닝 파이프라인 작업을 관리하고 표준화된 오케스트레이션 작업 간 글루 코드를 추상화 할 수 있다.

> 글루 코드(glue code) 파이프라인 단계 사이에서 불안정하며 커스텀 스크립트가 특정 사례 이상으로 확장되지 않는 코드

표준화된 머신러닝 파이프라인을 채택하는게 중요하다. (팀 프로젝트의 협업 문제)



### 1.4.1 방향 비순환 그래프

파이프라인과 파이프라인 툴들은 작업 종속성의 그래프 표현을 사용해 작업 흐름을 관리한다.

DAG (Directed Acyclic Graph, 방향 비순환 그래프)

- 모든 의존성이 완전히 계산되고 작업 시작
- 방향성을 갖고 비순환(다시 돌아가지않음)성을 갖춰야 파이프라인 실행



### 1.5 예제의 파이프라인 구성

<img src="C:\Users\jay\Desktop\code\DE\pipeline구축\살아움직이는 머신러닝 파이프라인 설계\1-2.PNG" alt="1-2" style="zoom:100%;" align="Left"/>

